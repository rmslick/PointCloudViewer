{% load static %}

<!DOCTYPE html>
<html>
<head>
	<title>Three.js Point Cloud</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <style>
		body {
			margin: 0;
			overflow: hidden;
		}
        #editor {
            
        width: 100%;
        height: 100%;

      }
	</style>
</head>
<body>
    <nav class="navbar navbar-light bg-light">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">
          <img src="/docs/5.0/assets/brand/bootstrap-logo.svg" alt="" width="30" height="24" class="d-inline-block align-text-top">
          Bootstrap
        </a>
        <button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">Script</button>
      </div>
      <div class="justify-content-md-end">
          <div class="offcanvas offcanvas-end w-50" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel">
            <div class="offcanvas-header">
                <h5 id="offcanvasRightLabel">Offcanvas right</h5>
                <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
                <div id="editor"></div>
                <button id="compile-btn" class="btn btn-primary">Compile</button>
                <div id="notification-container"></div>
            </div>
          </div>
      </div>

    </nav>
    <div id="container">

    </div>
    <script >
      function showNotification(message, type = 'info') {
        const notificationContainer = document.getElementById('notification-container');
        
        // Create the notification element
        const notification = document.createElement('div');
        notification.classList.add('alert', `alert-${type}`, 'alert-dismissible', 'fade', 'show');
        notification.setAttribute('role', 'alert');

        // Add the message to the notification
        notification.innerText = message;

        // Add the close button to the notification
        const closeButton = document.createElement('button');
        closeButton.classList.add('btn-close');
        closeButton.setAttribute('type', 'button');
        closeButton.setAttribute('data-bs-dismiss', 'alert');
        closeButton.setAttribute('aria-label', 'Close');
        notification.appendChild(closeButton);

        // Add the notification to the container
        notificationContainer.appendChild(notification);
      }
    </script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/three@0.134.0/build/three.min.js"></script>
    <script src="https://cdn.rawgit.com/mrdoob/three.js/r134/examples/js/controls/OrbitControls.js"></script>

	<script>
		var container, camera, scene, renderer, controls;
		var geometry, material, points;
		
		var positions = [];
		var spheres = [];
		init();
		animate();

		function init() {

			//container = document.createElement( 'div' );
      container = document.getElementById("container");
			document.body.appendChild( container );

			camera = new THREE.PerspectiveCamera(
				75,
				window.innerWidth / window.innerHeight,
				0.1,
				1000
			);
        	camera.position.z = 5;

        // Add ambient light to the scene

			scene = new THREE.Scene();
			scene.background = new THREE.Color( 0x050505 );

			// add an axis with visible origin
			var axesHelper = new THREE.AxesHelper(100);
			scene.add( axesHelper );

			// Create a random number of spheres with random positions and colors
			const numSpheres = Math.floor( Math.random() * 100) + 1;
			for (let i = 0; i < numSpheres; i++) {
				const geometry = new THREE.SphereGeometry(0.5, 32, 32);
				var c = 0xffffff;
				console.log("Color "+c);
				const material = new THREE.MeshStandardMaterial({
					color: c,
				});
				const sphere = new THREE.Mesh(geometry);
				sphere.position.set(
					Math.random() * 10 - 5,
					Math.random() * 10 - 5,
					Math.random() * 10 - 5
				);
				scene.add(sphere);
				spheres.push(sphere);
			}

			renderer = new THREE.WebGLRenderer( { antialias: true } );
			renderer.setPixelRatio( window.devicePixelRatio );
			renderer.setSize( window.innerWidth, window.innerHeight );
			container.appendChild( renderer.domElement );
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableZoom = true;
			window.addEventListener( 'resize', onWindowResize, false );

		}

		function onWindowResize() {

			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();

			renderer.setSize( window.innerWidth, window.innerHeight );

		}

		function animate() {
        requestAnimationFrame(animate);

        // Rotate the spheres
        spheres.forEach((sphere) => {
          sphere.rotation.x += 0.01;
          sphere.rotation.y += 0.01;
        });

        renderer.render(scene, camera);
      }

	</script>

    
    <script src="{% static 'monaco-editor-0.38.0/package/min/vs/loader.js' %}"></script>
    <script>
      require.config({ paths: { 'vs': '{% static "monaco-editor-0.38.0/package/min/vs" %}' }});
      require(['vs/editor/editor.main'], function() {
        monaco.languages.register({ id: 'python' });
        monaco.languages.setMonarchTokensProvider('python', {
          tokenizer: {
            root: [
              [/[a-z_$][\w$]*/, { token: 'identifier' }],
              [/\d+\.\d+/, { token: 'number.float' }],
              [/\d+/, { token: 'number' }],
              [/"([^"\\]|\\.)*$/, { token: 'string.invalid', next: '@string' }],
              [/"/, { token: 'string.quote', next: '@string' }],
              [/'[^\\']'/, { token: 'string' }],
            ],
            string: [
              [/[^\\"]+/, { token: 'string' }],
              [/\\./, { token: 'string.escape' }],
              [/"/, { token: 'string.quote', next: '@pop' }],
            ],
          },
        });
        monaco.languages.setLanguageConfiguration('python', {
          brackets: [['(', ')'], ['[', ']'], ['{', '}']],
          autoClosingPairs: [
            { open: '(', close: ')' },
            { open: '[', close: ']' },
            { open: '{', close: '}' },
            { open: "'", close: "'", notIn: ['string', 'comment'] },
            { open: '"', close: '"', notIn: ['string', 'comment'] },
          ],
        });
        const editor =monaco.editor.create(document.getElementById('editor'), {
          value: 'print("Hello, world!")',
          language: 'python',
          theme: 'vs-dark',
        });
        // Attach event listener to the Compile button
        const compileBtn = document.getElementById('compile-btn');
    compileBtn.addEventListener('click', () => {
      const code = editor.getValue();
      console.log(code);
      const userSessionId = '{{ request.session.session_key }}';
      fetch('{% url "compile" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ "code":code, user_session_id: userSessionId })
      })
      .then(response => response.json())
      .then(data => {
        console.log(data.output);
        if(data.error_code == 0)
        {
          showNotification('Compilation successful!', 'success');
        }
        else{  
          showNotification('Compilation failed!', 'danger');
        }

      })
      .catch(error => {
        console.error(error);
      });
    });
      });
    </script>
</body>
</html>